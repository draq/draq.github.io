<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Calendar">
  <title>Calendar</title>
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="stylesheet.css">
</head>

<body>
  <header>
    <h1>Astronomical and Calendrical Notes</h1> 
  </header>
  <main>
    <section>
      <h2>Date and Time</h2>
      <table>
        <tbody>
          <tr>
            <td>Universal Time (UTC)</td>
            <td id="utc-datetime"></td>
          </tr>
          <tr>
            <td>Julian Date (JD)</td>
            <td id="julian-date"></td>
          </tr>
        </tbody>
      </table>
    </section>
    <section>
      <h2>Solar Coordinates</h2>
      <table>
        <tbody>
          <tr>
            <td>Solar Ecliptic Longitude (&lambda;)</td>
            <td class="degree" id="solar-longitude"></td>
          </tr>
          <tr>
            <td>Solar Ecliptic Latitude (&beta;)</td>
            <td class="degree"  id="solar-latitude"></td>
          </tr>
          <tr>
            <td>Solar Distance (R)</td>
            <td id="solar-distance"></td>
          </tr>
          <tr>
            <td>Axial tilt (&epsilon;)</td>
            <td class="degree" id="axial-tilt"></td>
          </tr>
          <tr>
            <td>Right Ascension of the Sun (&alpha;)</td>
            <td id="right-ascension"></td>
          </tr>
          <tr>
            <td>Declination of the Sun (&delta;)</td>
            <td class="degree" id="declination"></td>
          </tr>
        </tbody>
      </table>
    </section>
  </main>
  <footer>
    <p>Thanks to <a href="https://quasar.as.utexas.edu/BillInfo/JulianDatesG.html">Bill Jefferys</a></p> 
   </p>
  </footer>
  <script>
    const J2000 = 2451545.0;  // Julian date at 2020-01-01

    function assertInteger() {
      for (element of arguments) {
        if (!Number.isInteger(element)){
          throw element + " is not an integer!";
        }
      }
      return true;
    }

    function calculateJulianDate(year, month, day, hour, minute) {
      if (year instanceof Date) {
        minute = year.getUTCMinutes();
        hour = year.getUTCHours();
        day = year.getUTCDate();
        month = year.getUTCMonth() + 1; // January is 0.
        year = year.getUTCFullYear();
      }
      else {
        assertInteger(...arguments);
      }
      console.debug(`Year = ${year}, Month = ${month}, Day = ${day}, Hour = ${hour}, Minute = ${minute}.`);

      if (month < 3) {
        // Year starts in March
        year -= 1;
        month += 12;
      }

      let a = Math.floor(year / 100); // century
      let b = Math.floor(a/4); // 25-year 
      let c = 2 - a + b;
      let e = Math.floor(365.25 * (year + 4716)); //  4714 BCE November 24, 12 hours GMT (Gregorian proleptic Calendar)
      let f = Math.floor(30.6001 * (month + 1));
      let julianDayNumber = c + day + e + f - 1524.5;
      let fraction = (hour + minute / 60) / 24;
      console.debug(`A = ${a}, B = ${b}, C = ${c}, E = ${e}, F = ${f}, fraction = ${fraction}.`);

      return julianDayNumber + fraction;
    }

    function calculateSolarEclipicCoordinates(julianDate) {
      let n = julianDate - J2000; // J2000
      let l = (280.460 + 0.9856474 * n) % 360;   // mean longitude in degrees
      let g = (357.528 + 0.9856003 * n) % 360;   // mean anomaly in degrees
      g = toRadian(g); // degree to radians
      let lambda = l + 1.915 * Math.sin(g) + 0.020 * Math.sin(2*g); // solar longitude
      let beta = 0; // approximately, solar latitude
      let r = 1.00014 - 0.01671 * Math.cos(g) - 0.00014 * Math.cos(2*g); // solar distance in astronomical units.
      
      return {
        longitude: lambda,
        latitude: beta,
        distance: r
      };
    }

    function getDecimalDegrees(degree, minute, second) {
      return degree + minute / 60 + second / 3600;
    }

    function getHourMinuteSecond (degree) {
      let hour = degree / 15;
      let h = Math.floor(hour);
      let minute = (hour - h) * 60;
      
      let m = Math.floor(minute);
      let second = (minute - m) * 60;

      return {
        degree: h,
        minute: m,
        second: second
      }
    }

    function toRadian(degree) {
      return degree / 180 * Math.PI;
    }

    function toDegree(radian, absolute=false) {
      let degree = radian / Math.PI * 180;
      if (absolute && degree < 360) {
        return degree + 360;
      } else {
        return degree;
      }
    }

    function calculateAxialTilt(julianDate) {
      let t = Math.floor((julianDate - J2000) / 100); // Julian centuries
      let c0 = getDecimalDegrees(23, 26, 21.406);
      let c1 = -getDecimalDegrees(0, 0, 46.836769);
      let c2 = -getDecimalDegrees(0, 0, 0.0001831);
      let c3 = getDecimalDegrees(0, 0, 0.00200340);
      let c4 = -getDecimalDegrees(0, 0, 5.76 * 10**-7);
      let c5 = -getDecimalDegrees(0, 0, 4.34 * 10**-8);
      let epsilon = c0 + c1 * t + c2 * t**2 + c3 * t**3 + c4 * t**4 + c5 * t**5;
      return epsilon;
    }

    function calculateEquitorialCoordiantes(eclipticLongitude, eclipticObliquity) {
      let lambda = toRadian(eclipticLongitude);
      let epsilon = toRadian(eclipticObliquity); 
      console.debug(`Longitude = ${lambda}, Obliquity = ${epsilon} (in radians)`);

      let alpha = Math.atan2(Math.cos(epsilon) * Math.sin(lambda), Math.cos(lambda));
      // alpha = Math.atan(Math.cos(epsilon) * Math.tan(lambda));
      alpha = toDegree(alpha, absolute=true);
      
      let delta = toDegree(Math.asin(Math.sin(epsilon) * Math.sin(lambda)));
      
      return { // in degree
        rightAscension: alpha,
        declination: delta
      };
    }

    let now = new Date();
    document.getElementById("utc-datetime").textContent = now.toUTCString();
    
    now = calculateJulianDate(now);
    document.getElementById("julian-date").textContent = now.toFixed(4);

    let {longitude, latitude, distance} = calculateSolarEclipicCoordinates(now);
    document.getElementById("solar-longitude").textContent = longitude.toFixed(4);
    document.getElementById("solar-latitude").textContent = latitude;
    document.getElementById("solar-distance").textContent = distance.toFixed(4);

    let obliquity = calculateAxialTilt(now);
    document.getElementById("axial-tilt").textContent = obliquity.toFixed(4);

    let {rightAscension, declination} = calculateEquitorialCoordiantes(longitude, obliquity);
    let {degree, minute, second} = getHourMinuteSecond(rightAscension);
    document.getElementById("right-ascension").textContent = `${degree}h ${minute}m ${second.toFixed(0)}s`;
    document.getElementById("declination").textContent = declination.toFixed(4);
  </script>
</body>
</html>
